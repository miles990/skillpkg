{
  "id": "snapshot_1767377106836_kdm6wyp8d",
  "approvalId": "approval_1767377106830_3q4w7tap0",
  "approvalTitle": "Design: skillpkg v2.0 架構設計",
  "version": 1,
  "timestamp": "2026-01-02T18:05:06.836Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: skillpkg v2.0\n\n## Overview\n\nskillpkg v2.0 extends the existing skill package manager with project-centric configuration (`skillpkg.json`), dependency management, and multi-tool sync capabilities. It builds upon the existing `adapters`, `parser`, `store`, and `importer` modules.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n| Module | Purpose | Reuse Strategy |\n|--------|---------|----------------|\n| `adapters/` | Tool-specific implementations (claude-code, cursor, copilot, codex) | Extend for sync functionality |\n| `parser/` | SKILL.md/skill.yaml parsing | Extend to parse `dependencies` field |\n| `store/` | Skill storage management | Extend for state.json management |\n| `importer/` | GitHub/URL skill import | Reuse for dependency fetching |\n| `github/` | GitHub search API | Reuse for skill discovery |\n\n### Integration Points\n\n- **Adapters**: Add `sync()` method to each adapter\n- **Parser**: Add `dependencies` field to schema\n- **Store**: Add `state.json` alongside existing skill storage\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        skillpkg v2.0                            │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐          │\n│  │    CLI      │   │ MCP Server  │   │    TUI      │          │\n│  │  (existing) │   │  (existing) │   │  (future)   │          │\n│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘          │\n│         │                 │                 │                  │\n│         └─────────────────┼─────────────────┘                  │\n│                           │                                    │\n│  ┌────────────────────────▼────────────────────────┐          │\n│  │                    CORE                          │          │\n│  ├──────────────────────────────────────────────────┤          │\n│  │  NEW MODULES:                                    │          │\n│  │  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │          │\n│  │  │ config/  │  │ resolver/│  │    sync/     │  │          │\n│  │  │(skillpkg │  │(Deps/MCP)│  │ (Multi-tool) │  │          │\n│  │  │ .json)   │  │          │  │              │  │          │\n│  │  └──────────┘  └──────────┘  └──────────────┘  │          │\n│  │                                                  │          │\n│  │  EXISTING (to extend):                          │          │\n│  │  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │          │\n│  │  │ store/   │  │ parser/  │  │  adapters/   │  │          │\n│  │  │(+state)  │  │(+deps)   │  │  (+sync)     │  │          │\n│  │  └──────────┘  └──────────┘  └──────────────┘  │          │\n│  │                                                  │          │\n│  └──────────────────────────────────────────────────┘          │\n│                                                                 │\n│  FILE SYSTEM:                                                  │\n│  ┌──────────────────────────────────────────────────┐          │\n│  │  skillpkg.json      (Project config - NEW)       │          │\n│  │  .skillpkg/                                      │          │\n│  │    ├── skills/      (Existing)                   │          │\n│  │    ├── cache/       (Existing)                   │          │\n│  │    └── state.json   (NEW)                        │          │\n│  └──────────────────────────────────────────────────┘          │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## Components and Interfaces\n\n### Component 1: ConfigManager (NEW)\n\n**Purpose:** Read/write `skillpkg.json` project configuration\n\n**File:** `packages/core/src/config/config-manager.ts`\n\n**Interfaces:**\n```typescript\ninterface SkillpkgConfig {\n  name: string;\n  version?: string;\n  skills: Record<string, string>;      // name -> source\n  mcp?: Record<string, McpConfig>;\n  reminders?: string[];\n  hooks?: Record<string, string>;\n  sync_targets?: Record<SyncTarget, boolean>;\n}\n\ninterface McpConfig {\n  package: string;\n  required?: boolean;\n  command?: string;\n  args?: string[];\n}\n\ntype SyncTarget = 'claude-code' | 'cursor' | 'codex' | 'copilot' | 'windsurf';\n\nclass ConfigManager {\n  loadProjectConfig(projectPath: string): Promise<SkillpkgConfig>;\n  saveProjectConfig(projectPath: string, config: SkillpkgConfig): Promise<void>;\n  initProject(projectPath: string, name: string): Promise<void>;\n  addSkill(projectPath: string, name: string, source: string): Promise<void>;\n  removeSkill(projectPath: string, name: string): Promise<void>;\n}\n```\n\n**Dependencies:** `ajv` (schema validation), `fs/promises`\n\n**Reuses:** Schema validation pattern from `parser/validator.ts`\n\n### Component 2: StateManager (NEW)\n\n**Purpose:** Track installation state, dependencies, and sync history\n\n**File:** `packages/core/src/state/state-manager.ts`\n\n**Interfaces:**\n```typescript\ninterface SkillState {\n  version: string;\n  source: string;\n  installed_by: 'user' | string;\n  installed_at: string;\n  depended_by: string[];\n}\n\ninterface McpState {\n  package: string;\n  installed_by_skill?: string;\n  installed_at: string;\n}\n\ninterface State {\n  $schema: string;\n  skills: Record<string, SkillState>;\n  mcp: Record<string, McpState>;\n  sync_history: Record<SyncTarget, string>;\n}\n\nclass StateManager {\n  loadState(projectPath: string): Promise<State>;\n  saveState(projectPath: string, state: State): Promise<void>;\n  recordSkillInstall(projectPath: string, name: string, info: SkillInstallInfo): Promise<void>;\n  recordSkillUninstall(projectPath: string, name: string): Promise<void>;\n  getDependents(state: State, skillName: string): string[];\n  canUninstall(state: State, skillName: string): { canUninstall: boolean; dependents: string[] };\n}\n```\n\n**Dependencies:** `fs/promises`\n\n**Reuses:** None (new module)\n\n### Component 3: DependencyResolver (NEW)\n\n**Purpose:** Resolve skill→skill and skill→MCP dependencies\n\n**File:** `packages/core/src/resolver/dependency-resolver.ts`\n\n**Interfaces:**\n```typescript\ninterface SkillDependencies {\n  skills?: string[];\n  mcp?: string[];\n}\n\ninterface ResolvedDependency {\n  name: string;\n  source: string;\n  type: 'skill' | 'mcp';\n  transitive: boolean;\n}\n\nclass DependencyResolver {\n  resolveDependencies(skillSource: string, installed: Set<string>): Promise<ResolvedDependency[]>;\n  buildDependencyTree(skillName: string, state: State): DependencyNode;\n  detectCircular(dependencies: ResolvedDependency[]): string[] | null;\n}\n```\n\n**Dependencies:** `parser` module\n\n**Reuses:** `importer` for fetching skill metadata\n\n### Component 4: Syncer (NEW)\n\n**Purpose:** Sync skills to multiple AI tool directories\n\n**File:** `packages/core/src/sync/syncer.ts`\n\n**Interfaces:**\n```typescript\ninterface SyncTargetConfig {\n  skillsDir: string;\n  mcpConfigFile?: string;\n  singleFile?: boolean;\n  transformer?: (content: string) => string;\n}\n\ninterface SyncResult {\n  success: boolean;\n  skillsSynced: string[];\n  errors: string[];\n}\n\nclass Syncer {\n  syncToTarget(projectPath: string, target: SyncTarget, skills: Map<string, string>): Promise<SyncResult>;\n  syncAll(projectPath: string): Promise<Map<SyncTarget, SyncResult>>;\n  transformForTarget(content: string, target: SyncTarget): string;\n  syncMcpConfig(projectPath: string, target: SyncTarget, mcp: Record<string, McpConfig>): Promise<void>;\n}\n```\n\n**Dependencies:** `adapters` module, `fs/promises`\n\n**Reuses:** Adapter implementations from `adapters/` for target-specific logic\n\n### Component 5: Extended Parser (EXTEND)\n\n**Purpose:** Parse `dependencies` field from SKILL.md frontmatter\n\n**File:** `packages/core/src/parser/schema.ts` (extend)\n\n**Changes:**\n```typescript\n// Add to existing SkillMetadata\ninterface SkillMetadata {\n  // ... existing fields\n  dependencies?: {\n    skills?: string[];\n    mcp?: string[];\n  };\n}\n```\n\n**Reuses:** Existing `parser.ts` and `validator.ts`\n\n### Component 6: Extended Adapters (EXTEND)\n\n**Purpose:** Add sync capability to each adapter\n\n**Files:** `packages/core/src/adapters/*.ts`\n\n**Changes:**\n```typescript\n// Add to BaseAdapter interface\ninterface BaseAdapter {\n  // ... existing methods\n  sync(skills: Map<string, string>): Promise<SyncResult>;\n  getSyncConfig(): SyncTargetConfig;\n}\n```\n\n**Reuses:** Existing adapter implementations\n\n## Data Models\n\n### skillpkg.json Schema\n```typescript\n{\n  \"$schema\": \"https://skillpkg.dev/schemas/skillpkg.json\",\n  \"name\": string,           // Required\n  \"version\": string,        // Optional, semver\n  \"skills\": {\n    [name: string]: string  // source (github:user/repo, url, local path)\n  },\n  \"mcp\": {\n    [name: string]: {\n      \"package\": string,    // npm package name\n      \"required\": boolean,  // default: false\n      \"command\": string,    // executable command\n      \"args\": string[]      // command arguments\n    }\n  },\n  \"reminders\": string[],\n  \"hooks\": {\n    [name: string]: string  // script path\n  },\n  \"sync_targets\": {\n    \"claude-code\": boolean,\n    \"cursor\": boolean,\n    \"codex\": boolean,\n    \"copilot\": boolean,\n    \"windsurf\": boolean\n  }\n}\n```\n\n### state.json Schema\n```typescript\n{\n  \"$schema\": \"skillpkg-state-v1\",\n  \"skills\": {\n    [name: string]: {\n      \"version\": string,\n      \"source\": string,\n      \"installed_by\": \"user\" | string,\n      \"installed_at\": string,        // ISO 8601\n      \"depended_by\": string[]\n    }\n  },\n  \"mcp\": {\n    [name: string]: {\n      \"package\": string,\n      \"installed_by_skill\": string | null,\n      \"installed_at\": string\n    }\n  },\n  \"sync_history\": {\n    [target: string]: string         // ISO 8601\n  }\n}\n```\n\n## Sync Target Configurations\n\n| Target | Skills Directory | MCP Config | Format |\n|--------|------------------|------------|--------|\n| claude-code | `.claude/skills/{name}/SKILL.md` | `.mcp.json` | Directory per skill |\n| cursor | `.cursor/rules/{name}.md` | `.cursor/mcp.json` | File per skill |\n| codex | `AGENTS.md` | - | Single combined file |\n| copilot | `.github/copilot-instructions.md` | - | Single combined file |\n| windsurf | `.windsurf/rules/{name}.md` | `.windsurf/mcp.json` | File per skill |\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Circular Dependency Detected**\n   - **Handling:** Abort installation, show dependency chain\n   - **User Impact:** \"Circular dependency detected: A → B → C → A\"\n\n2. **Uninstall with Dependents**\n   - **Handling:** Show dependents, require `--force` or user confirmation\n   - **User Impact:** \"Cannot uninstall X: depended on by Y, Z. Use --force to override.\"\n\n3. **MCP Installation Failed**\n   - **Handling:** Log error, continue with skill install, mark MCP as not installed\n   - **User Impact:** \"Warning: MCP 'cipher' failed to install. Skill may not work correctly.\"\n\n4. **Sync Target Not Writable**\n   - **Handling:** Skip target, report error\n   - **User Impact:** \"Failed to sync to cursor: Permission denied. Skipped.\"\n\n5. **Invalid skillpkg.json**\n   - **Handling:** Show validation errors with line numbers\n   - **User Impact:** \"Invalid skillpkg.json at line 5: 'skills' must be an object\"\n\n## Testing Strategy\n\n### Unit Testing\n- **ConfigManager**: Read/write/validate operations\n- **StateManager**: State updates, dependency queries\n- **DependencyResolver**: Resolution, circular detection\n- **Syncer**: Format transformation\n\n### Integration Testing\n- Full install flow with dependencies\n- Sync to multiple targets\n- Uninstall with dependency cleanup\n\n### E2E Testing\n- CLI command workflows\n- MCP server tool invocations\n\n## File Structure (Final)\n\n```\npackages/core/src/\n├── config/                 # NEW\n│   ├── config-manager.ts\n│   ├── schemas/\n│   │   └── skillpkg.schema.json\n│   └── index.ts\n├── state/                  # NEW\n│   ├── state-manager.ts\n│   └── index.ts\n├── resolver/               # NEW\n│   ├── dependency-resolver.ts\n│   └── index.ts\n├── sync/                   # NEW\n│   ├── syncer.ts\n│   ├── transformers.ts\n│   └── index.ts\n├── adapters/               # EXTEND\n│   ├── base.ts            # Add sync interface\n│   ├── claude-code.ts     # Add sync implementation\n│   ├── cursor.ts          # Add sync implementation\n│   ├── copilot.ts         # Add sync implementation\n│   ├── codex.ts           # Add sync implementation\n│   └── windsurf.ts        # NEW adapter\n├── parser/                 # EXTEND\n│   └── schema.ts          # Add dependencies field\n├── store/                  # EXISTING\n├── importer/               # EXISTING\n├── github/                 # EXISTING\n├── types.ts\n└── index.ts               # Export new modules\n```\n",
  "fileStats": {
    "size": 14670,
    "lines": 400,
    "lastModified": "2026-01-02T18:04:58.093Z"
  },
  "comments": []
}