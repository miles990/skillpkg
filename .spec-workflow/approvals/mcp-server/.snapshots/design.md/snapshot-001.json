{
  "id": "snapshot_1767345416863_gp9acl394",
  "approvalId": "approval_1767345416861_estx2zvq6",
  "approvalTitle": "MCP Server Design",
  "version": 1,
  "timestamp": "2026-01-02T09:16:56.863Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: skillpkg MCP Server\n\n## Overview\n\nskillpkg MCP Server 是一個實作 Anthropic MCP (Model Context Protocol) 的服務，讓 AI Agent 能透過標準化協議存取 skillpkg 的功能。Server 使用 stdio transport，可被 Claude Desktop、Cursor 等 MCP 客戶端呼叫。\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        Architecture                             │\n│                                                                 │\n│  ┌──────────────┐     stdio      ┌──────────────────────────┐  │\n│  │  MCP Client  │ ◄────────────► │    skillpkg serve        │  │\n│  │  (Claude/    │                │                          │  │\n│  │   Cursor)    │                │  ┌────────────────────┐  │  │\n│  └──────────────┘                │  │   MCP Server       │  │  │\n│                                  │  │   (Tool Router)    │  │  │\n│                                  │  └─────────┬──────────┘  │  │\n│                                  │            │             │  │\n│                                  │  ┌─────────▼──────────┐  │  │\n│                                  │  │   Tool Handlers    │  │  │\n│                                  │  │  ├─ search_skills  │  │  │\n│                                  │  │  ├─ load_skill     │  │  │\n│                                  │  │  ├─ install_skill  │  │  │\n│                                  │  │  ├─ list_skills    │  │  │\n│                                  │  │  ├─ uninstall_skill│  │  │\n│                                  │  │  ├─ search_registry│  │  │\n│                                  │  │  └─ skill_info     │  │  │\n│                                  │  └─────────┬──────────┘  │  │\n│                                  │            │             │  │\n│                                  │  ┌─────────▼──────────┐  │  │\n│                                  │  │   skillpkg-core    │  │  │\n│                                  │  │  (Existing Logic)  │  │  │\n│                                  │  └────────────────────┘  │  │\n│                                  └──────────────────────────┘  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n| Component | Location | Usage |\n|-----------|----------|-------|\n| `LocalStore` | `skillpkg-core/store/local.ts` | 讀取/寫入本地 skills |\n| `GlobalStore` | `skillpkg-core/store/global.ts` | 讀取/寫入全域 skills |\n| `RegistryClient` | `skillpkg-core/registry/client.ts` | 搜尋/下載 registry skills |\n| `parse()` | `skillpkg-core/parser/` | 解析 skill.yaml |\n| `createInstaller` | `skillpkg-core/installer/` | 安裝 skills |\n\n### Integration Points\n\n- **CLI Commands**: MCP tools 與 CLI commands 共用相同的 core 邏輯\n- **Store**: 使用現有的 LocalStore/GlobalStore 存取 skills\n- **Registry**: 使用現有的 RegistryClient 與 registry 互動\n\n## Architecture\n\n### Package Structure\n\n```\npackages/\n├── core/                    # 現有 (不變)\n│   ├── store/\n│   ├── parser/\n│   ├── registry/\n│   └── installer/\n├── cli/                     # 現有 (新增 serve command)\n│   ├── commands/\n│   │   ├── serve.ts         # NEW: 啟動 MCP Server\n│   │   └── ... (existing)\n│   └── index.ts\n└── mcp-server/              # NEW: MCP Server 套件\n    ├── server.ts            # MCP Server 主程式\n    ├── tools/               # Tool handlers\n    │   ├── index.ts\n    │   ├── search-skills.ts\n    │   ├── load-skill.ts\n    │   ├── install-skill.ts\n    │   ├── list-skills.ts\n    │   ├── uninstall-skill.ts\n    │   ├── search-registry.ts\n    │   └── skill-info.ts\n    ├── types.ts             # MCP 相關型別\n    └── index.ts\n```\n\n## Components and Interfaces\n\n### Component 1: MCP Server (`server.ts`)\n\n- **Purpose:** 處理 MCP 協議、路由 tool 呼叫\n- **Interfaces:**\n  ```typescript\n  class SkillpkgMcpServer {\n    constructor(options?: ServerOptions)\n    start(): Promise<void>\n    stop(): Promise<void>\n  }\n\n  interface ServerOptions {\n    scope?: 'local' | 'global'  // 預設 scope\n    projectPath?: string        // 專案路徑\n  }\n  ```\n- **Dependencies:** `@modelcontextprotocol/sdk`, `skillpkg-core`\n- **Reuses:** 無，全新組件\n\n### Component 2: Tool Handlers (`tools/`)\n\n每個 tool 是一個獨立模組，遵循相同介面：\n\n- **Purpose:** 處理特定 MCP tool 的邏輯\n- **Interfaces:**\n  ```typescript\n  interface ToolHandler {\n    name: string\n    description: string\n    inputSchema: JSONSchema\n    execute(args: unknown): Promise<ToolResult>\n  }\n\n  interface ToolResult {\n    content: Array<{\n      type: 'text'\n      text: string\n    }>\n    isError?: boolean\n  }\n  ```\n- **Dependencies:** `skillpkg-core`\n- **Reuses:** Store, Parser, Registry, Installer from core\n\n### Component 3: Serve Command (`cli/commands/serve.ts`)\n\n- **Purpose:** CLI 進入點，啟動 MCP Server\n- **Interfaces:**\n  ```bash\n  skillpkg serve [options]\n    --scope <scope>     # local | global (default: local)\n    --project <path>    # Project path for local scope\n  ```\n- **Dependencies:** `skillpkg-mcp-server`\n- **Reuses:** CLI framework (commander)\n\n## Data Models\n\n### Tool: search_skills\n\n```typescript\n// Input\ninterface SearchSkillsInput {\n  query: string           // 搜尋關鍵字\n  source?: 'all' | 'local' | 'registry'  // 預設 'all'\n  limit?: number          // 預設 20\n}\n\n// Output\ninterface SearchSkillsOutput {\n  results: Array<{\n    id: string            // skill identifier\n    name: string\n    description: string\n    version: string\n    source: 'local' | 'registry'\n    installed: boolean    // 是否已安裝\n  }>\n  total: number\n  query: string\n}\n```\n\n### Tool: load_skill\n\n```typescript\n// Input\ninterface LoadSkillInput {\n  id: string              // skill id\n}\n\n// Output\ninterface LoadSkillOutput {\n  id: string\n  name: string\n  version: string\n  description: string\n  instructions: string    // 完整 instructions 內容\n  author?: {\n    name: string\n    url?: string\n  }\n}\n```\n\n### Tool: install_skill\n\n```typescript\n// Input\ninterface InstallSkillInput {\n  source: string          // skill name, GitHub URL, HTTP URL, gist:id, 或本地路徑\n  scope?: 'local' | 'global'  // 預設 'local'\n}\n\n// Output\ninterface InstallSkillOutput {\n  success: boolean\n  skill: {\n    id: string\n    name: string\n    version: string\n    source: string        // 安裝來源\n    installedAt: string   // ISO timestamp\n  }\n  message: string\n}\n```\n\n### Tool: list_skills\n\n```typescript\n// Input\ninterface ListSkillsInput {\n  scope?: 'all' | 'local' | 'global'  // 預設 'all'\n}\n\n// Output\ninterface ListSkillsOutput {\n  skills: Array<{\n    id: string\n    name: string\n    description: string\n    version: string\n    scope: 'local' | 'global'\n    installedAt: string\n  }>\n  total: number\n}\n```\n\n### Tool: uninstall_skill\n\n```typescript\n// Input\ninterface UninstallSkillInput {\n  id: string\n  scope?: 'local' | 'global'\n}\n\n// Output\ninterface UninstallSkillOutput {\n  success: boolean\n  message: string\n}\n```\n\n### Tool: search_registry\n\n```typescript\n// Input\ninterface SearchRegistryInput {\n  query: string\n  limit?: number          // 預設 20\n}\n\n// Output\ninterface SearchRegistryOutput {\n  results: Array<{\n    name: string\n    description: string\n    version: string\n    author: string\n    downloads: number\n  }>\n  total: number\n}\n```\n\n### Tool: skill_info\n\n```typescript\n// Input\ninterface SkillInfoInput {\n  name: string            // skill name in registry\n}\n\n// Output\ninterface SkillInfoOutput {\n  name: string\n  description: string\n  version: string\n  author: {\n    name: string\n    email?: string\n    url?: string\n  }\n  repository?: string\n  license?: string\n  platforms?: string[]\n  tags?: string[]\n  readme?: string         // README 內容（如有）\n}\n```\n\n## Source Detection Logic\n\n`install_skill` 需要自動偵測來源類型：\n\n```typescript\nfunction detectSourceType(source: string): SourceType {\n  // GitHub URL\n  if (source.startsWith('github:') ||\n      source.includes('github.com/')) {\n    return 'github'\n  }\n\n  // Gist\n  if (source.startsWith('gist:') ||\n      source.includes('gist.github.com/')) {\n    return 'gist'\n  }\n\n  // HTTP URL (zip/tarball)\n  if (source.startsWith('http://') ||\n      source.startsWith('https://')) {\n    return 'url'\n  }\n\n  // Local path\n  if (source.startsWith('./') ||\n      source.startsWith('/') ||\n      source.startsWith('~')) {\n    return 'local'\n  }\n\n  // Default: registry\n  return 'registry'\n}\n\ntype SourceType = 'registry' | 'github' | 'gist' | 'url' | 'local'\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Skill Not Found**\n   - **Handling:** 回傳 error result，建議搜尋或安裝\n   - **User Impact:** AI 收到建議訊息，可選擇搜尋或安裝\n\n2. **Registry Unavailable**\n   - **Handling:** 回傳 error，但本地功能仍可用\n   - **User Impact:** AI 知道只能使用本地 skills\n\n3. **Installation Failed**\n   - **Handling:** 回傳詳細錯誤訊息和可能的解決方案\n   - **User Impact:** AI 可以嘗試其他安裝方式\n\n4. **Invalid Source Format**\n   - **Handling:** 回傳 error，列出支援的格式\n   - **User Impact:** AI 可以修正 source 格式\n\n### Error Response Format\n\n```typescript\ninterface ErrorResult {\n  content: [{\n    type: 'text'\n    text: string  // 包含錯誤訊息和建議\n  }]\n  isError: true\n}\n\n// Example\n{\n  content: [{\n    type: 'text',\n    text: `Error: Skill \"foo\" not found locally.\n\nSuggestions:\n- Search registry: search_skills({ query: \"foo\" })\n- Install from registry: install_skill({ source: \"foo\" })\n- Check available skills: list_skills()`\n  }],\n  isError: true\n}\n```\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Tool Handlers**: 每個 tool 獨立測試輸入驗證和輸出格式\n- **Source Detection**: 測試各種來源格式的偵測\n- **Error Handling**: 測試各種錯誤情況的回應\n\n### Integration Testing\n\n- **MCP Protocol**: 測試完整的 MCP request/response 流程\n- **Store Integration**: 測試與 LocalStore/GlobalStore 的整合\n- **Registry Integration**: 測試與 Registry API 的整合\n\n### End-to-End Testing\n\n- **Claude Desktop**: 手動測試與 Claude Desktop 的整合\n- **Full Workflow**: 測試 search → install → load → use 完整流程\n\n## Configuration\n\n### MCP Client Configuration\n\n```json\n// claude_desktop_config.json\n{\n  \"mcpServers\": {\n    \"skillpkg\": {\n      \"command\": \"skillpkg\",\n      \"args\": [\"serve\"],\n      \"env\": {\n        \"SKILLPKG_SCOPE\": \"local\"\n      }\n    }\n  }\n}\n\n// With global scope\n{\n  \"mcpServers\": {\n    \"skillpkg\": {\n      \"command\": \"skillpkg\",\n      \"args\": [\"serve\", \"--scope\", \"global\"]\n    }\n  }\n}\n```\n\n### Environment Variables\n\n| Variable | Description | Default |\n|----------|-------------|---------|\n| `SKILLPKG_SCOPE` | Default scope for operations | `local` |\n| `SKILLPKG_REGISTRY_URL` | Custom registry URL | (default registry) |\n| `SKILLPKG_PROJECT_PATH` | Project path for local scope | (current directory) |\n",
  "fileStats": {
    "size": 12154,
    "lines": 442,
    "lastModified": "2026-01-02T09:16:42.563Z"
  },
  "comments": []
}